<!doctype html>
<html>
<head>
<link rel="stylesheet"
	href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css"
	integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh"
	crossorigin="anonymous">

<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

<style>
	.mt-50 {
		margin-top: calc(40vh);
	}
</style>

</head>

<body>
	<main class="mt-50">
		<div class="container-fluid waiting-result">
			<div class="d-flex justify-content-center">
				<div class="card" style="width: 50rem;">
				  <div class="card-body">
				    <h5 class="card-title">
				    <div class="d-flex align-items-center">
				  		<strong>Processando <span class="attempt">9<span></strong>
				  		<div class="spinner-border ml-auto" role="status" aria-hidden="true"></div>
					</div>		
				    </h5>
				    <p class="card-text">Aguarde por favor, estamos processando sua resposta.</p>
				  </div>
				</div>
			</div>
		</div>
	</main>
</body>

<script src="https://code.jquery.com/jquery-3.4.1.slim.min.js"
	integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n"
	crossorigin="anonymous"></script>
<script
	src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"
	integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6"
	crossorigin="anonymous"></script>

<script>
	const checkResponse = (checkUrl) => {
		if (!checkUrl) {
			checkUrl = '${dto.link}';
		}
		fetch(checkUrl)
		   .then((response) => {
		       if(!response.ok){
		           throw new Error('failed!');
		       }
		       return response.json();
		   }).then((data) => {
 			  if (data && !data.found) {
 			  	$('.attempt').text(data.retryAttempt + 1)
 			  	if (data.finished) {
 			  		location.href = data.link
 			  	} else {
	 			  	setTimeout(checkResponse, data.retryTimeout, data.link)
 			  	}
 			  } else if (data && data.found) {
 			  	location.href = data.link
 			  }
		   }).catch((error) => {
			  console.log(error);
		   });
	}

	$(document).ready(() => {
		setTimeout(checkResponse, 5000)
	})

</script>


</html>